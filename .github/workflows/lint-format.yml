name: Lint and Format

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]

jobs:
  lint-and-format:
    name: ESLint & Prettier Check
    runs-on: ubuntu-latest

    steps:
      # ============================================
      # CHECKOUT
      # ============================================
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìã Log checkout info
        run: |
          echo "‚úÖ Repository checked out successfully"
          echo "üìÅ Current directory: $(pwd)"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üìù Commit SHA: ${{ github.sha }}"

      # ============================================
      # NODE.JS SETUP
      # ============================================
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: üìã Log Node.js version
        run: |
          echo "‚úÖ Node.js setup complete"
          echo "üì¶ Node version: $(node --version)"
          echo "üì¶ npm version: $(npm --version)"

      # ============================================
      # DEPENDENCIES
      # ============================================
      - name: üì¶ Install dependencies
        run: |
          echo "üì• Installing dependencies with npm ci..."
          npm ci
          echo "‚úÖ Dependencies installed successfully"

      # ============================================
      # ESLINT CHECK
      # ============================================
      - name: üîç Run ESLint
        id: eslint
        run: |
          echo "üîç Running ESLint to check for code quality issues..."
          echo "üìÅ Checking files in ./src/"
          npm run lint
          echo "‚úÖ ESLint check passed - no issues found"

      - name: üí° ESLint fix suggestion
        if: failure() && steps.eslint.outcome == 'failure'
        run: |
          echo "‚ùå ESLint found issues in your code"
          echo "üí° To fix automatically, run: npm run lint:fix"
          echo "üìñ Review the errors above and fix them before committing"

      # ============================================
      # PRETTIER CHECK
      # ============================================
      - name: üé® Run Prettier format check
        id: prettier
        run: |
          echo "üé® Running Prettier to check code formatting..."
          npm run format:check
          echo "‚úÖ Prettier check passed - code is properly formatted"

      - name: üí° Prettier fix suggestion
        if: failure() && steps.prettier.outcome == 'failure'
        run: |
          echo "‚ùå Prettier found formatting issues"
          echo "üí° To fix automatically, run: npm run format"
          echo "üìñ This will reformat your code according to project standards"

      # ============================================
      # SUMMARY
      # ============================================
      - name: üìä Generate summary
        if: always()
        run: |
          echo "## üîç Lint & Format Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | ${{ steps.eslint.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prettier | ${{ steps.prettier.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üí° Quick Fixes" >> $GITHUB_STEP_SUMMARY
          echo "- **ESLint issues:** \`npm run lint:fix\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Formatting issues:** \`npm run format\`" >> $GITHUB_STEP_SUMMARY

      # ============================================
      # ANNOTATIONS
      # ============================================
      - name: ‚ùå Annotate failures
        if: failure()
        run: |
          echo "::error::Lint or format check failed. Please run 'npm run lint:fix' and 'npm run format' locally before pushing."
