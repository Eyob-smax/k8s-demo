name: Tests

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]

env:
  NODE_ENV: test
  NODE_OPTIONS: --experimental-vm-modules

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      # ============================================
      # CHECKOUT
      # ============================================
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“‹ Log checkout info
        run: |
          echo "âœ… Repository checked out successfully"
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit SHA: ${{ github.sha }}"
          echo "ğŸ”§ Event: ${{ github.event_name }}"

      # ============================================
      # NODE.JS SETUP
      # ============================================
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: ğŸ“‹ Log Node.js environment
        run: |
          echo "âœ… Node.js setup complete"
          echo "ğŸ“¦ Node version: $(node --version)"
          echo "ğŸ“¦ npm version: $(npm --version)"
          echo "ğŸ”§ NODE_ENV: $NODE_ENV"
          echo "ğŸ”§ NODE_OPTIONS: $NODE_OPTIONS"

      # ============================================
      # DEPENDENCIES
      # ============================================
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¥ Installing dependencies with npm ci..."
          npm ci
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ“‹ Log installed packages
        run: |
          echo "ğŸ“¦ Key testing packages installed:"
          npm list jest ts-jest cross-env --depth=0 || true

      # ============================================
      # RUN TESTS
      # ============================================
      - name: ğŸ§ª Run tests with coverage
        id: tests
        env:
          NODE_ENV: test
          NODE_OPTIONS: --experimental-vm-modules
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ§ª Starting test suite with coverage..."
          echo "â±ï¸ Test started at: $(date)"
          npm run test:coverage
          echo "âœ… Tests completed successfully"
          echo "â±ï¸ Test finished at: $(date)"

      # ============================================
      # COVERAGE ARTIFACTS
      # ============================================
      - name: ğŸ“Š Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: ğŸ“‹ Log coverage upload
        if: always()
        run: |
          echo "ğŸ“Š Coverage report uploaded as artifact"
          echo "ğŸ“ Artifact name: coverage-report"
          echo "â° Retention: 30 days"

      # ============================================
      # SUMMARY
      # ============================================
      - name: ğŸ“Š Generate test summary
        if: always()
        run: |
          echo "## ğŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ steps.tests.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js | 20.x |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "Coverage report has been uploaded as an artifact and will be retained for 30 days." >> $GITHUB_STEP_SUMMARY
          
          # Display coverage summary if available
          if [ -f coverage/coverage-summary.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“ˆ Coverage Summary" >> $GITHUB_STEP_SUMMARY
            cat coverage/coverage-summary.json | head -50 >> $GITHUB_STEP_SUMMARY || true
          fi

      # ============================================
      # ANNOTATIONS
      # ============================================
      - name: âŒ Annotate test failures
        if: failure()
        run: |
          echo "::error::Tests failed. Please review the test output above and fix failing tests before merging."
          echo "ğŸ’¡ Run 'npm run test' locally to debug failing tests"
